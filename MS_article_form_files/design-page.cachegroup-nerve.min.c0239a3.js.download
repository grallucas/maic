"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[527],{41293:function(n,t,r){function i(n,t){n||(console.assert(n,"Nerve - "+t),s("assert failed: ".concat(t)))}function e(n){return s("TODO: ".concat(n))}function u(){return s("to be overridden.")}function o(n){if(n="Nerve - warning: ".concat(n),console.warn(n),c){var t=new Error(n).stack;c(t)}}r.d(t,{ZK:function(){return o},_y:function(){return s},ct:function(){return u},hu:function(){return i},ys:function(){return e}});var c=null;function s(n){throw Error("Nerve - "+n)}},42874:function(n,t,r){r.d(t,{k:function(){return e},s:function(){return u}});var i=r(36630),e=function(){return function(n){void 0===n&&(n={}),u(this,n)}}();function u(n,t,r){void 0===r&&(r=!1),(0,i.zO)(n,"__nerve__",t,r)}},39923:function(n,t,r){r.d(t,{J4:function(){return w},bn:function(){return a},f4:function(){return h},u9:function(){return l}});var i=r(26203),e=r(41293),u=r(42874),o=r(36630),c="Spec",s=Object.freeze({IsKeyField:!1,IsLocalField:!1,IsNumberTypeInDataSource:!1,IsSourceGenerated:!1});function f(n,t){var r=v();if(i.d.isObjectMasterClass(n))r.masterClassGetter=function(){return n};else{if(!(n instanceof Function))throw Error("The parameter of Spec.fromMasterClass should be a master class of a function.");r.masterClassGetter=n}return d(r,t)}function h(n){var t=n;return t&&t.__nerve__&&t.__nerve__.nerveObjectType===c}function a(n,t){t?Object.keys(t).forEach((function(r){return m(n+r,t[r])})):g(n,"there's no spec passed")}function l(n){return h(n)?n.__nerve__.attributes:s}function v(){return{attributes:s,basicTypeName:null,enumTypeGetter:null,isCollection:!1,isLeaf:!1,keyGetter:null,masterClassGetter:null,nullable:!1,nerveObjectType:c}}function d(n,t){var r={};return b(n,t),(0,u.s)(r,(0,o.fm)(n)),r}function b(n,t){if((t=t||{}).IsKeyField){switch(n.basicTypeName){case"boolean":case"string":case"number":break;default:(0,e._y)('"isKeyField" only supported for basic type fields')}t.IsLocalField&&(0,e._y)("a local field can't be key field.")}var r={IsSourceGenerated:!!t.IsSourceGenerated,IsExpandedField:!!t.IsExpandedField,IsKeyField:!!t.IsKeyField,IsLocalField:!!t.IsLocalField,IsNumberTypeInDataSource:!!t.IsNumberTypeInDataSource,SourceFieldName:t.SourceFieldName,IgnoreKeyWithEmptyValue:!!t.IgnoreKeyWithEmptyValue};n.attributes=Object.freeze(r)}function m(n,t){t?h(t)?t.__nerve__.isCollection&&m(n+"[0]",t[0]):a(n,t):g(n,"empty field spec")}function g(n,t){throw Error("Spec error of ".concat(n,": ").concat(t,"."))}function y(n){return function(t,r){return function(n,t,r){var i=v();return i.isLeaf=!0,i.basicTypeName=n,i.keyGetter=r||null,b(i,t),d(i,t)}(n,t,r)}}var w=Object.freeze({create:function(n,t){var r;return b(r=h(n)?(0,o.kI)(n.__nerve__):v(),t),(0,o.kt)(d(r,t),n)},boolean:y("boolean"),number:y("number"),string:y("string"),enumeration:function(n,t){var r=v();return r.isLeaf=!0,r.basicTypeName="enum",r.enumTypeGetter=n,b(r,t),d(r,t)},reference:y("reference"),collectionOf:function(n,t){var r;r=h(n)?n:i.d.isObjectMasterClass(n)||n instanceof Function?f(n):n;var e=v();e.isCollection=!0;var u=d(e,t);return(0,o.zO)(u,0,r),u},fromMasterClass:f})},36630:function(n,t,r){r.d(t,{Bx:function(){return l},Cb:function(){return d},EA:function(){return u},GP:function(){return S},Je:function(){return w},Ko:function(){return v},L:function(){return a},_x:function(){return o},bC:function(){return g},fm:function(){return f},kI:function(){return s},kt:function(){return c},uF:function(){return b},uG:function(){return m},wU:function(){return y},z2:function(){return h},zO:function(){return e}});var i=r(41293);function e(n,t,r,i){void 0===i&&(i=!0),p(n,t,{configurable:!1,enumerable:!!i,value:r,writable:!1})}function u(n,t,r){p(n,t,{configurable:!0,enumerable:!0,get:function(){var i=r();return delete n[t],e(n,t,i),i},set:function(){throw Error("Setting readonly field: ".concat(t))}})}function o(n,t,r,i){p(n,t,{configurable:!1,enumerable:!0,get:r,set:i=i||function(){throw new Error("Setting readonly field: ".concat(t))}})}function c(n,t){var r=n;for(var i in t)r[i]=t[i];return r}function s(n){return c({},n)}function f(n){(0,i.hu)(!Array.isArray(n),"array is not currently supported by readonly().");var t={};for(var r in n)e(t,r,n[r]);return t}function h(n,t){(0,i.hu)(t in n,"the field named ".concat(t," not been initialized yet.")),e(n,t,n[t])}function a(n){return Array.isArray(n)?n:function(n){return n?Array.prototype.slice.apply(n):[]}(n)}function l(n){var t=function(){return Promise.resolve(null)};return n?n.then(t,t):t()}function v(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return new Promise((function(t,r){var i=n.length,e=[];n.forEach((function(n,u){return n.then((function(n){return t(n)})).catch((function(n){e[u]=n,0==--i&&r.apply(void 0,e)}))}))}))}var d,b=function(){function n(n,t){void 0===t&&(t=0),this.t=n,this.i=t}return n.prototype.callOnceLater=function(){var n=this;0!==this.i&&null!=this.u&&this.clear(),null==this.u&&(this.u=window.setTimeout((function(){n.callImmediately()}),this.i))},n.prototype.flush=function(){null!=this.u&&(this.clear(),this.t())},n.prototype.callImmediately=function(){null!=this.u&&this.clear(),this.t()},n.prototype.clear=function(){this.u&&(clearTimeout(this.u),this.u=void 0)},n}(),m=function(){function n(n){var t=this;this.o=new Promise((function(r,i){n.then((function(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];t.h||r.apply(void 0,n)}),(function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];t.h||i(n)}))}))}return n.prototype.promise=function(){return this.o},n.prototype.cancel=function(){this.h=!0},n}();!function(n){n[n.Pending=0]="Pending",n[n.Resolved=1]="Resolved",n[n.Rejected=2]="Rejected"}(d||(d={}));var g=function(){function n(n,t){void 0===t&&(t=d.Pending);var r=this;n.then((function(){r.l=d.Resolved}),(function(){r.l=d.Rejected})),this.v=n,this.l=t}return n.prototype.promise=function(){return this.v},n.prototype.states=function(){return this.l},n}(),y=function(){function n(){var n=this;this.v=new g(new Promise((function(t,r){n.m=t,n.g=r})))}return n.prototype.promise=function(){return this.v.promise()},n.prototype.resolve=function(){return this.m(),this},n.prototype.reject=function(n){return this.g(n),this},n.prototype.states=function(){return this.v.states()},n}();function w(){return(new y).resolve()}function p(n,t,r){try{Object.defineProperty(n,t,r)}catch(n){var e=n&&n.message||"(no message)";(0,i._y)('Failed to set property "'.concat(t,'": ').concat(e))}}function S(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var r=[];return n.forEach((function(n){n&&n.then?r.push(n):r.push(Promise.resolve(n))})),Promise.all(r)}},26203:function(n,t,r){r.d(t,{d:function(){return Cn}});var i=r(59312),e=r(41293),u=function(){function n(t){t instanceof n?this.p(t.S):this.O(t)}return Object.defineProperty(n.prototype,"Count",{get:function(){return this.S.fieldCount},enumerable:!1,configurable:!0}),n.prototype.has=function(n){return this.hasId(on(n))},n.prototype.hasId=function(n){return!!this.S.map[n]},n.prototype.intersect=function(n){if(Array.isArray(n))return n.some(this.has.bind(this));var t=this,r=n;if(r.Count<t.Count){var i=t;t=r,r=i}for(var e in t.S.map)if(r.S.map[e])return!0;return!1},n.prototype.intersection=function(t){var r=this;if(Array.isArray(t))return new n(t.filter((function(n){return rn(n)&&r.has(n)})));if(t instanceof n){var i=this,e=t;if(e.Count<i.Count){var u=i;i=e,e=u}var o=new n;for(var c in i.S.map)e.hasId(c)&&o.addFieldSchema(fn(c));return o}return new n},n.prototype.toArray=function(){return Object.keys(this.S.map).map(fn)},n.prototype.clone=function(){return new n(this)},n.prototype.clear=function(){this.O()},n.prototype.addFieldSchema=function(n){this.has(n)||(this.j(),this.I(n))},n.prototype.addFieldSchemas=function(t){var r,i=this;(r=(r=t instanceof n?t.toArray():t).filter((function(n){return!i.has(n)}))).length&&(this.j(),this.I.bind(this),r.forEach((function(n){return i.I(n)})))},n.prototype.removeFieldSchema=function(n){this.has(n)&&(this.j(),this.F(n))},n.prototype.removeFieldSchemas=function(t){var r,i=this;(r=(r=t instanceof n?t.toArray():t).filter((function(n){return i.has(n)}))).length&&(this.j(),r.forEach((function(n){return i.F(n)})))},n.prototype.j=function(){1!==this.S.referenceCount&&this.O(this.toArray())},n.prototype.I=function(n){var t=on(n);this.S.map[t]||(this.S.map[t]=!0,++this.S.fieldCount)},n.prototype.F=function(n){var t=on(n);this.S.map[t]&&(delete this.S.map[t],--this.S.fieldCount)},n.prototype.O=function(n){this.p({map:{},fieldCount:0,referenceCount:0}),n&&this.addFieldSchemas(n)},n.prototype.p=function(n){this.S&&--this.S.referenceCount,this.S=n,++this.S.referenceCount},n}(),o=r(42874),c=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),t.prototype.toJSON=function(){return this.__nerve__.master.getSnapshot()},t}(o.k),s=r(36630);function f(n){if(n instanceof c)return n.__nerve__.master;(0,e._y)("Invalid parameter: please use '<your master>.Model.*' for the parameter.")}function h(n){return function(n){if(n instanceof a)return n.constructor;(0,e._y)("the parameter is not a nerve master object.")}(n).__nerve__.masterName}var a=function(n){function t(t){var r=n.call(this)||this,i=r.__nerve__,e=t&&t.Reserved&&t.Reserved.Membership;e&&(i.membership=(0,s.fm)(e),(0,s.z2)(i,"membership"));var u=!1;return(0,s._x)(i,"deleted",(function(){return u}),(function(n){if(!u&&n){u=!0,i.dirtyChecker.updateDirtiness();var t=i.changeManager;t.startBulkEditMode(),i.markChildrenAsDeleted(),t.markAsDeleted(),t.endBulkEditMode()}})),i.instanceId=(++l).toString(),(0,s.z2)(i,"instanceId"),r}return(0,i.ZT)(t,n),Object.defineProperty(t.prototype,"Schema",{get:function(){return(0,e.ct)()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Model",{get:function(){return this.__nerve__.model},set:function(n){this.setData(n,this.Schema.__nerve__.subFields.toArray())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Parent",{get:function(){var n=this.__nerve__.membership;return n&&n.Parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Membership",{get:function(){var n=this.__nerve__.membership;return{Parent:n&&n.Parent,FieldSchema:n&&n.FieldSchema}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Deleted",{get:function(){return this.__nerve__.deleted},set:function(n){this.__nerve__.deleted=n},enumerable:!1,configurable:!0}),t.prototype.getInstanceId=function(){return this.__nerve__.instanceId},t.prototype.getSnapshot=function(n){return this.__nerve__.changeManager.getSnapshot(n)},t.prototype.bulkEdit=function(n){var t=this.__nerve__.changeManager;t&&t.startBulkEditMode();try{return n(this.Model)}finally{t&&t.endBulkEditMode()}},t.prototype.observe=function(n,t){return this.__nerve__.changeManager.observe(n,t)},t.prototype.unobserve=function(n,t){return this.__nerve__.changeManager.unobserve(n,t)},t.prototype.addRule=function(n){return this.__nerve__.changeManager.addRule(n)},t.prototype.removeRule=function(n){return this.__nerve__.changeManager.removeRule(n)},t}(o.k),l=0,v=function(){function n(n){this.C=n,this.P=[],this.M=0,this.N=(0,s.Je)(),this.D=new s.uF(this.T.bind(this)),this.K=[],this.initializeSnapshot(),this.resetChangeInfo()}return n.prototype.getSnapshot=function(n){if(!this.A){for(var t in this.R)this.refreshSubSnapshot(this.R[t]);this.R={},this.A=this.createSnapshotCache()}return this.A},n.prototype.definitelyMarkAsChanged=function(n){this.G=!0,this.markAsChanged(n)},n.prototype.markAsChanged=function(n,t){this.U();var r=n.FieldSchema,i=new u([r]);if(this.J.addFieldSchema(r),t){this.V.push(t);var e=t.FieldSchemas.map(r.__nerve__.shadowMapper);i.addFieldSchemas(e)}this.markFieldsAsChanged(i)},n.prototype.markAsDeleted=function(){this.markFieldsAsChanged([this.C.Schema])},n.prototype.startBulkEditMode=function(){++this.M},n.prototype.endBulkEditMode=function(){--this.M<=0&&(this.M=0,this.D.flush())},n.prototype.observe=function(n,t){var r=this.P[this._(n)];r?t?r.fieldSet.addFieldSchemas(t):r.fieldSet=this.B().clone():this.P.push({callback:n,fieldSet:new u(t||this.B())})},n.prototype.unobserve=function(n,t){var r=this._(n),i=this.P[r];i&&(t?t.forEach((function(n){i.fieldSet.removeFieldSchemas(n.__nerve__.allContainedFields)})):i.fieldSet.clear(),0===i.fieldSet.Count&&this.P.splice(r,1))},n.prototype.addRule=function(n){this.K.indexOf(n)<0&&this.K.push(n)},n.prototype.removeRule=function(n){var t=this.K.indexOf(n);t>=0&&this.K.splice(t,1)},n.prototype.markSubSnapshotAsDirty=function(n){var t=this;if(n.length){this.A=void 0,n.forEach((function(n){return t.R[n.Name]=n}));var r=this.Master.__nerve__.membership,i=r&&r.Parent.__nerve__.changeManager;i&&i.markSubSnapshotAsDirty([r.Property])}},n.prototype.getChangingPeriod=function(){return this.N.promise()},Object.defineProperty(n.prototype,"Master",{get:function(){return this.C},enumerable:!1,configurable:!0}),n.prototype.createChange=function(n){var t=this.Master.__nerve__.deleted&&!this.W;return{BeingDeleted:t,DefinitelyMarked:this.G,FieldSchemas:Object.freeze(n.toArray()),Master:this.Master,NewValues:t?null:this.getSnapshot(),OldValues:this.Z,SubChanges:Object.freeze(this.V),UpdateNeeded:t}},n.prototype.resetChangeInfo=function(){this.J=new u,this.V=[],this.Z=this.getSnapshot(),this.W=this.C.Deleted,this.G=!1},n.prototype.notifyChangeIfNeed=function(){this.M>0?this.D.callOnceLater():this.D.callImmediately()},n.prototype.anythingChanged=function(){return this.J.Count>0||this.Master.__nerve__.deleted},n.prototype.markFieldsAsChanged=function(n,t){var r=this;this.J.addFieldSchemas(n),this.q?this.H=!0:t?t.then((function(){return r.notifyChangeIfNeed()})):this.notifyChangeIfNeed()},n.prototype.shouldObserverBeNotified=function(n,t){return n.fieldSet.intersect(t.FieldSchemas)},n.prototype.removeUnchangedFields=function(n,t){},n.prototype._=function(n){for(var t=0;t<this.P.length;++t)if(this.P[t].callback===n)return t},n.prototype.T=function(){var n=this;if(this.X(),this.Y(),this.G||this.Master.Deleted||this.removeUnchangedFields(this.J,this.Z),this.anythingChanged()){var t=Object.freeze(this.createChange(this.J));this.resetChangeInfo();var r=this.Master.__nerve__.membership;if(r&&r.Property.Mounted){var i=r.Parent.__nerve__.changeManager;i&&i.markAsChanged(r.Property,t)}this.P.concat().forEach((function(r){n.shouldObserverBeNotified(r,t)&&r.callback(t)}))}},n.prototype.X=function(){var n=this;this.q=!0;var t=0,r=this.J,i=this.V,e=[],o=function(){var o=c.K.filter((function(t){return!t.InterestedFields||n.J.intersect(t.InterestedFields)}));if(!o.length)return"break";if(++t>8*c.K.length)return c.$(e),"break";var s=c.J,f=c.V;c.J=new u,c.V=[];var h=c.Master.__nerve__.deleted&&!c.W;o.forEach((function(t){n.H=!1,t.onChange({Master:n.Master,BeingDeleted:h,FieldSchemas:s.toArray(),OldValues:n.Z,SubChanges:f}),n.H&&e.push(t)})),r.addFieldSchemas(c.J),i.push.apply(i,c.V)},c=this;do{if("break"===o())break}while(this.J.Count);this.q=!1,this.J=r,this.V=i},n.prototype.$=function(n){(0,e.ZK)("following rules might do against each other: ".concat(JSON.stringify(n.map((function(n){return n.Name})))," (master: ").concat(h(this.Master),")"))},n.prototype.B=function(){return this.Master.Schema.__nerve__.allContainedFields},n.prototype.U=function(){this.N.states()!==s.Cb.Pending&&(this.N=new s.wU)},n.prototype.Y=function(){this.N.resolve()},n}(),d=function(){function n(n){this.nn=n}return n.prototype.updateDirtiness=function(){if(this.nn){var n=this.getProperty();n.ParentMaster.__nerve__.dirtyChecker.setMemberDirtiness(n.Name,this.isDirty())}},n}(),b=function(n){function t(t,r){var i=n.call(this,r)||this;return i.tn=t,i}return(0,i.ZT)(t,n),t.prototype.isDirty=function(){return this.rn!==this.convertModelToSourceData()},t.prototype.initializeSourceData=function(n){this.setSourceData(n)},t.prototype.getDelta=function(){return this.convertModelToSourceData()},t.prototype.getSnapshotToUpdate=function(){return this.convertModelToSourceData()},t.prototype.getSourceData=function(){return this.rn},t.prototype.setSourceData=function(n){void 0===n&&(n=null),this.rn=n,this.updateDirtiness()},t.prototype.onSourceDataReceived=function(n){var t=this.isDirty();this.setSourceData(n),t||this.tn.setter(this.convertFromSourceData(n))},t.prototype.getProperty=function(){return this.tn},t.prototype.convertModelToSourceData=function(){return this.tn.getter()},t.prototype.convertFromSourceData=function(n){return n},t}(d),m=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),t.prototype.convertModelToSourceData=function(){return this.en(this.getProperty().getter())},t.prototype.convertFromSourceData=function(n){return this.en(n)},t.prototype.en=function(n){return null==n?null:this.getProperty().FieldSchema.__nerve__.enumType[n]},t}(b),g=function(){function n(n,t,r){var i=this;this.un=n,this.on=t;var e=r.Reserved.Membership;this.cn=e.Parent,e.Property=this,this.sn=!1,r.Reserved.Mounted.then((function(){return i.sn=!0}))}return Object.defineProperty(n.prototype,"Name",{get:function(){return this.un},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"FieldSchema",{get:function(){return this.on},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ParentMaster",{get:function(){return this.cn},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"Index",{get:function(){return this.fn},set:function(n){if(n!==this.fn){var t=this.fn;this.fn=n;var r=this.ParentMaster;this.indexDirtinessUpdateNeeded()&&r.__nerve__.dirtyChecker.updateDirtinessForIndexChange(this),this.Mounted&&r.__nerve__.changeManager.onPropertyIndexChange(this,t)}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"Mounted",{get:function(){return this.sn},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"Deleted",{get:function(){return this.hn},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ParentDirtyChecker",{get:function(){return this.ParentMaster.__nerve__.dirtyChecker},enumerable:!1,configurable:!0}),n.prototype.markAsDeleted=function(n){this.hn=!0,this.Index=void 0},n.prototype.getKey=function(){return this.on.__nerve__.getKey(this.getter())},n}(),y=function(n){function t(t,r,i){var e=n.call(this,t,r,i)||this;e.an=e.normalizeValue(i.InitialData);var u=!r.__nerve__.info.Attributes.IsLocalField;return e.ln=e.createDirtyChecker(u),e}return(0,i.ZT)(t,n),t.prototype.getter=function(){return this.an},t.prototype.setter=function(n){if(n=this.normalizeValue(n),this.an!==n){this.an=n,this.ln.updateDirtiness();var t=this.ParentMaster.__nerve__.changeManager;t.markSubSnapshotAsDirty([this]),t.markAsChanged(this)}},t.prototype.getDirtyChecker=function(){return this.ln},t.prototype.normalizeValue=function(n){return null==n?null:n},t.prototype.createDirtyChecker=function(n){return new b(this,n)},t.prototype.indexDirtinessUpdateNeeded=function(){return!0},t}(g),w=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),t.prototype.normalizeValue=function(n){var t=typeof n;if("string"===t||"number"===t){var r=this.FieldSchema.__nerve__.enumType;if(n in r)return"string"===t?r[n]:n}return null},t.prototype.createDirtyChecker=function(n){return new m(this,n)},t}(y),p=r(39923);function S(n){return n.__nerve__.info.IsLeaf}function O(n,t,r,i,e){var u=dn({enumTypeGetter:r.__nerve__.enumTypeGetter,getKeyForReferenceType:r.__nerve__.keyGetter,info:{Attributes:(0,p.u9)(r),FieldId:n,IsLeaf:!0,IsCollection:!1,Name:i,Path:e||i},parentMasterClass:t,parentSchema:t.__nerve__.schema,withDataSource:!1});return u.__nerve__.generateProperty=function(n){return n.__nerve__.asEnum?function(t,r){return new w(t,n,r)}:function(t,r){return new y(t,n,r)}}(u),(0,s.z2)(u.__nerve__,"generateProperty"),u}var j=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),t.prototype.markAsChanged=function(t,r){r&&r.BeingDeleted?this.Master.deleteItems([t.getter()]):n.prototype.markAsChanged.call(this,t,r)},t.prototype.onPropertiesAdded=function(n,t){n.length&&(this.vn=this.vn.concat(n),this.dn=void 0,this.markSubSnapshotAsDirty(n),this.markFieldsAsChanged(this.Master.Schema.__nerve__.allContainedFields,t))},t.prototype.onPropertiesRemoved=function(n,t){var r=this;n.length&&(n.forEach((function(n){var t=r.vn.indexOf(n);t>=0?r.vn.splice(t,1):r.mn.push(n),r.gn[n.Name]&&(delete r.gn[n.Name],--r.yn)})),this.dn=void 0,this.markSubSnapshotAsDirty(n),this.markFieldsAsChanged(this.Master.Schema.__nerve__.allContainedFields,t))},t.prototype.onPropertyIndexChange=function(n,t){this.markSubSnapshotAsDirty([n]),this.gn[n.Name]?this.gn[n.Name].NewIndex=n.Index:(this.gn[n.Name]={OldIndex:t,NewIndex:n.Index},++this.yn),this.notifyChangeIfNeed()},t.prototype.initializeSnapshot=function(){S(this.Master.Schema[0])?this.wn=t.getSubSnapshotForLeafContent:this.wn=t.getSubSnapshotForMasterContent,this.pn()},t.prototype.refreshSubSnapshot=function(n){this.dn&&!n.Deleted&&(this.dn[n.Index]=this.wn(n.getter()))},t.prototype.createSnapshotCache=function(){return this.dn||this.pn(),this.dn.concat()},t.prototype.createChange=function(t){var r=this,i=n.prototype.createChange.call(this,t),e=function(n){return n.getter()},u=function(n){return r.wn(n)};i.AddedModels=Object.freeze(this.vn.map(e)),i.AddedItemsAsSnapshots=Object.freeze(i.AddedModels.map(u)),i.RemovedModels=Object.freeze(this.mn.map(e)),i.RemovedItemsAsSnapshots=Object.freeze(i.RemovedModels.map(u));var o={};Object.keys(this.gn).forEach((function(n){var t=r.gn[n];null!=t.NewIndex&&null!=t.OldIndex&&(o[t.NewIndex]=t.OldIndex)})),i.ChangedIndexMap=Object.freeze(o);var c=this.Master.Schema[0];return i.UpdateNeeded||c.__nerve__.info.Attributes.IsLocalField||(i.UpdateNeeded=i.AddedModels.length>0||i.RemovedModels.length>0||i.SubChanges.some((function(n){return n.UpdateNeeded}))),i},t.prototype.resetChangeInfo=function(){n.prototype.resetChangeInfo.call(this),this.vn=[],this.mn=[],this.gn={},this.yn=0},t.prototype.anythingChanged=function(){return this.vn.length>0||this.mn.length>0||this.yn>0||n.prototype.anythingChanged.call(this)},t.prototype.shouldObserverBeNotified=function(t,r){return!!Object.keys(r.ChangedIndexMap).length||n.prototype.shouldObserverBeNotified.call(this,t,r)},t.prototype.pn=function(){this.dn=[];for(var n=this.Master.Model,t=0;t<n.length;++t)this.dn[t]=this.wn(n[t])},t.getSubSnapshotForLeafContent=function(n){return n},t.getSubSnapshotForMasterContent=function(n){return f(n).getSnapshot()},t}(v),I=function(n){function t(t,r,i){var e=n.call(this,i)||this;return e.Sn={},e.On=0,e.C=t,e.jn=r,e}return(0,i.ZT)(t,n),Object.defineProperty(t.prototype,"Master",{get:function(){return this.C},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ExistingInSource",{get:function(){return this.jn},set:function(n){this.jn=n,this.updateDirtiness()},enumerable:!1,configurable:!0}),t.prototype.isDirty=function(){if(this.C.__nerve__.deleted){var n=this.Master.Parent;return!(n&&n.__nerve__.deleted)&&this.jn}return 0!==this.On},t.prototype.setMemberDirtiness=function(n,t){!this.Sn[n]!=!t&&(t?(this.Sn[n]=!0,0==this.On++&&this.updateDirtiness()):(delete this.Sn[n],0==--this.On&&this.updateDirtiness()))},t.prototype.getDirtyKeys=function(){return Object.keys(this.Sn)},t.prototype.getProperty=function(){return this.C.__nerve__.membership.Property},t}(d),F=function(n){function t(t,r,i){var e=n.call(this,t,r,i)||this;return e.In([]),e}return(0,i.ZT)(t,n),t.prototype.initializeSourceData=function(n){var t=this;this.In(n||[]),this.Fn().forEach((function(n){var r=n.getDirtyChecker(),i=t.rn[t.Cn(n)];r.initializeSourceData(i)})),this.updateDirtinessForLength(this.Master.Model.length)},t.prototype.getDelta=function(){return(0,e.ys)("get delta for collection is not supported yet.")},t.prototype.getSnapshotToUpdate=function(){return this.Fn().map((function(n){return n.getDirtyChecker()})).map((function(n){return n.getSnapshotToUpdate()}))},t.prototype.getSourceData=function(){return ln(this.rn,this.Master.Schema)},t.prototype.setSourceData=function(n){this.setSourceDataInternal(n||[])},t.prototype.onSourceDataReceived=function(n){n=n||[],this.In(n),this.Master.Model.__nerve__.onSourceDataReceived(n),this.updateDirtinessForLength(this.Master.Model.length)},t.prototype.updateDirtinessForLength=function(n){this.setMemberDirtiness("length",n!==this.getSourceDataLength())},t.prototype.updateDirtinessForIndexChange=function(n){n.Deleted?this.setMemberDirtiness(n.Name,!1):n.getDirtyChecker().setSourceData(this.rn[n.Index])},t.prototype.getSourceDataLength=function(){return this.rn.length},t.prototype.setSourceDataInternal=function(n){var t=this;this.In(n),this.Fn().forEach((function(n){var r=n.getDirtyChecker(),i=t.Cn(n);r.setSourceData(t.rn[i]),r instanceof I&&(r.ExistingInSource=i<t.rn.length)})),this.updateDirtinessForLength(this.Master.Model.length)},t.prototype.Fn=function(){return this.Master.Model.__nerve__.properties},t.prototype.In=function(n){var t=this;this.rn=n;var r=this.Master.Schema[0];r.__nerve__.withKey&&(this.Pn={},n.map(r.__nerve__.getKeyFromSourceData).forEach((function(n,r){n&&(t.Pn[n]=r)})))},t.prototype.Cn=function(n){return this.Master.Schema[0].__nerve__.withKey?this.Pn[n.getKey()]:n.Index},t}(I),C=function(n){function t(t,r){var i,e,u=this,o=t.Schema[0];o.__nerve__.withKey?(i=k,e=R):(i=o.__nerve__.info.IsLeaf?K:A,e=x);var c=r.Reserved&&r.Reserved.ParentExistingInDataSource;return(u=n.call(this,{master:t,keyToProperty:o.__nerve__.withKey?{}:null,initializedLength:0,newestPropertyName:0,masterTreeReady:r.MasterTreeReady,properties:[],addItems:function(n,t){return P(u,n,t,c)},deleteItems:function(n,t){return function(n,t,r){var i=n.__nerve__.properties.filter((function(n){var r=n.getter();return t.some((function(n){return n===r}))}));return D(n,i,r),i}(u,n,t)},setData:function(n){return i(u,n)},onSourceDataReceived:function(n){return e(u,n)},setComparer:function(n){u.__nerve__.comparer=n,u.__nerve__.propertyComparer=n&&function(t,r){return n(t.getter(),r.getter())},n&&E(u,u.__nerve__.propertyComparer)}})||this).ensureFieldsReadyPromiseChain=Promise.resolve([]),P(u,(0,s.L)(r.InitialData),r.ExistingInDataSource,c),u}return(0,i.ZT)(t,n),Object.defineProperty(t.prototype,"length",{get:function(){return this.__nerve__.properties.length},enumerable:!1,configurable:!0}),t}(c);function P(n,t,r,i){var e=n.__nerve__.master,u=e.Schema[0],o=u.__nerve__.generateProperty,c=new s.wU,f=(0,s.GP)(n.__nerve__.masterTreeReady,c.promise()),h=t.map((function(t){return o((++n.__nerve__.newestPropertyName).toString(),{InitialData:t,ExistingInDataSource:r,MasterTreeReady:f,Reserved:{Membership:{Parent:e,FieldSchema:u},ParentExistingInDataSource:i,Mounted:c.promise()}})})),a=[n.ensureFieldsReadyPromiseChain];if(u.__nerve__.withKey){var l=n.__nerve__.keyToProperty,v=u.__nerve__.ignoreKeyWithEmptyValueFields;if(u.__nerve__.withDataSource){var d=u.__nerve__.keyFields.toArray();h.forEach((function(n){var t=n.Master;a.push(t.Synchronizer.ensureFieldsReady(d).then((function(){return M(l,n,v,!0)})))}))}h.forEach((function(n){return M(l,n,v)}))}var b=n.__nerve__.properties,m=b.length;return e.bulkEdit((function(){b.push.apply(b,h),function(n){var t=n.__nerve__,r=t.properties.length;for(;t.initializedLength<r;)N(n,t.initializedLength),++t.initializedLength}(n);for(var t=m;t<b.length;++t)b[t].Index=t;e.__nerve__.dirtyChecker.updateDirtinessForLength(b.length);var r=n.__nerve__.propertyComparer;r&&E(n,r),c.resolve();var i=e.__nerve__.changeManager,u=Promise.all(a);n.ensureFieldsReadyPromiseChain=u,i&&i.onPropertiesAdded(h,u)})),h}function M(n,t,r,i){void 0===i&&(i=!1);var u=t.getKey();if(u){if(u in n){if(i||r[u])return;(0,e._y)('duplicated key "'.concat(u,'" at ').concat(sn(t.FieldSchema)," is being added."))}n[u]=t}}function N(n,t){(0,s._x)(n,t,(function(){return t>=this.__nerve__.properties.length&&(0,e._y)("Get item out of range. Index: ".concat(t,"; Length: ").concat(this.__nerve__.properties.length)),this.__nerve__.properties[t].getter()}),(function(n){t>=this.__nerve__.properties.length&&(0,e._y)("Set item out of range. Index: ".concat(t,"; Length: ").concat(this.__nerve__.properties.length)),this.__nerve__.properties[t].setter(n)}))}function D(n,t,r){var i=t.length;if(i>0){var e=n.__nerve__.properties,u=e.length,o=n.__nerve__.master;o.bulkEdit((function(){for(;i>0;--i){for(var c=t[i-1];--u>c.Index;)e[u].Index-=i;e.splice(u,1),c.markAsDeleted(r)}var s=o.Schema[0],f=[n.ensureFieldsReadyPromiseChain];if(s.__nerve__.withKey){var h=n.__nerve__.keyToProperty;if(s.__nerve__.withDataSource){var a=s.__nerve__.keyFields.toArray();t.forEach((function(n){var t=n.Master;f.push(t.Synchronizer.ensureFieldsReady(a).then((function(){return T(h,n)})))}))}t.forEach((function(n){return T(h,n)}))}var l=Promise.all(f);n.ensureFieldsReadyPromiseChain=l,o.__nerve__.dirtyChecker.updateDirtinessForLength(e.length),o.__nerve__.changeManager.onPropertiesRemoved(t,l)}))}}function T(n,t){var r=t.getKey();r&&r in n&&t===n[r]&&delete n[r]}function E(n,t){t&&n.__nerve__.properties.sort(t),n.__nerve__.master.bulkEdit((function(){n.__nerve__.properties.forEach((function(n,t){n.Index=t}))}))}function k(n,t){var r=n.__nerve__.master,i=n.__nerve__.master.Schema[0],e=n.__nerve__.properties,u={};t.map(i.__nerve__.getKey).forEach((function(n,t){return u[n]=t}));var o={};e.forEach((function(n){return o[n.getKey()]=n}));var c={};r.bulkEdit((function(){var r=[];for(var i in u){var e=u[i];if(i in o){var s=o[i];s.setter(t[e]),c[s.Name]=e,delete o[i]}else r.push(e)}var f=[];for(var i in o)f.push(o[i]);f.length&&(f.sort((function(n,t){return n.Index-t.Index})),D(n,f,!1)),r.length&&n.__nerve__.addItems(r.map((function(n){return t[n]})),!1).forEach((function(n,t){return c[n.Name]=r[t]}));var h=function(n,t){return c[n.Name]-c[t.Name]},a=n.__nerve__.propertyComparer;E(n,a?function(n,t){return a(n,t)||h(n,t)}:h)}))}function K(n,t){for(var r=n.__nerve__.master,i={},u=(0,s.L)(n.__nerve__.master.getSnapshot()).slice(),o=[],c={},f=0;f<t.length;++f){var h=t[f],a=u.indexOf(h);a<0?o.push(h):(c[f]=a,u[a]=i)}var l=n.__nerve__.properties,v=[];for(f=0;f<u.length;++f)u[f]!==i&&v.push(l[f]);var d=l.slice();r.bulkEdit((function(){var r=n.__nerve__.addItems(o,!1);v.length&&(v.sort((function(n,t){return n.Index-t.Index})),D(n,v,!1)),(0,e.hu)(t.length===l.length,"All items should be updated into properties.");for(var i=0,u=0;u<t.length;++u)null==c[u]?l[u]=r[i++]:l[u]=d[c[u]];E(n,n.__nerve__.propertyComparer)}))}function A(n,t){n.__nerve__.master.bulkEdit((function(){var r=n.length,i=Math.min(r,t.length),e=n.__nerve__.properties;t=t.map((function(n,t){return n instanceof c?t<r&&e[t].getter()===n?n:f(n).getSnapshot():n}));for(var u=0;u<i;++u)e[u].setter(t[u]);if(r<t.length)n.__nerve__.addItems(t.slice(n.length),!1);else if(r>t.length){var o=n.__nerve__.properties.slice(t.length);D(n,o,!1)}}))}function R(n,t){var r=n.__nerve__.master;r.bulkEdit((function(){var i,e=r.Schema[0].__nerve__,u=n.__nerve__.keyToProperty,o={},c=[];t.map(e.getKeyFromSourceData).forEach((function(n,r){o[n]=r,n in u?u[n].getDirtyChecker().onSourceDataReceived(t[r]):c.push(t[r])})),i=e.withDataSource?function(n){return n.Master.Synchronizer.existingInDataSourcePromiseState()===s.Cb.Resolved&&!(n.getKey()in o)}:function(n){return!(n.getKey()in o)};var f=n.__nerve__.properties.filter(i);D(n,f,!0);var h=hn(c,r.Schema);n.__nerve__.addItems(h,!0);var a=n.__nerve__.propertyComparer;a||(a=function(n,t){return o[n.getKey()]-o[t.getKey()]}),E(n,a)}))}function x(n,t){var r=n.__nerve__.master;r.bulkEdit((function(){for(var i=n.length,e=Math.min(i,t.length),u=n.__nerve__.properties,o=0;o<e;++o)u[o].getDirtyChecker().onSourceDataReceived(t[o]);if(i<t.length){var c=hn(t.slice(i),r.Schema);n.__nerve__.addItems(c,!0)}else if(i>t.length){var s=n.__nerve__.properties.slice(t.length);D(n,s,!0)}}))}var G="collection master";var U=function(n){function t(t){var r;t=t||{};var i=r=n.call(this,t)||this,e=r.__nerve__;e.markChildrenAsDeleted=function(){var n;S((n=i).Schema[0])||(0,s.L)(n.Model).map(f).forEach((function(n){return n.Deleted=!0}))},(0,s.z2)(e,"markChildrenAsDeleted");var u=r.Schema.__nerve__,o=!u.withDataSource&&!u.info.Attributes.IsLocalField;return e.dirtyChecker=new F(i,t.ExistingInDataSource,o),(0,s.z2)(e,"dirtyChecker"),e.model=new C(i,t),(0,s.z2)(e,"model"),e.changeManager=new j(i),(0,s.z2)(e,"changeManager"),r}return(0,i.ZT)(t,n),t.prototype.addItems=function(n){return this.Model.__nerve__.addItems(n,!1).map((function(n){return n.getter()}))},t.prototype.deleteItems=function(n){return this.Model.__nerve__.deleteItems(n,!1).map((function(n){return n.getter()}))},t.prototype.itemsAddedInSource=function(n){return this.Model.__nerve__.addItems(n,!0).map((function(n){return n.getter()}))},t.prototype.itemsDeletedInSource=function(n){return this.Model.__nerve__.deleteItems(n,!0).map((function(n){return n.getter()}))},t.prototype.getItemWithKeyFields=function(n){var t=this.Schema[0].__nerve__.getKey(n),r=this.Model.__nerve__.keyToProperty[t];return r&&r.getter()},t.prototype.getIndexWithKeyFields=function(n){var t=this.Schema[0].__nerve__.getKey(n),r=this.Model.__nerve__.keyToProperty[t];return r?r.Index:-1},t.prototype.markAsChanged=function(n){var t=this.Model.__nerve__.properties[n];t&&this.__nerve__.changeManager.definitelyMarkAsChanged(t)},t.prototype.setComparer=function(n){this.Model.__nerve__.setComparer(n)},t.prototype.setData=function(n){this.Model.__nerve__.setData((0,s.L)(n))},t}(a);var L=function(n){function t(t,r,i){var e=n.call(this,t,r,i)||this,u=r.__nerve__.subMasterClassGetter();return e.C=new u(i),e}return(0,i.ZT)(t,n),Object.defineProperty(t.prototype,"Master",{get:function(){return this.C},enumerable:!1,configurable:!0}),t.prototype.getter=function(){return this.C.Model},t.prototype.setter=function(n){this.C.setData(n,this.C.Schema.__nerve__.subFields.toArray())},t.prototype.markAsDeleted=function(t){n.prototype.markAsDeleted.call(this,t),t&&(this.getDirtyChecker().ExistingInSource=!1),this.C.Deleted=!0},t.prototype.getDirtyChecker=function(){return this.C.__nerve__.dirtyChecker},t.prototype.indexDirtinessUpdateNeeded=function(){return!this.FieldSchema.__nerve__.withDataSource},t}(g);function z(n){return n.__nerve__.info.IsCollection}function Q(n,t,r,i,u,o){var c=r.Schema,f=c.__nerve__,h=dn({enumTypeGetter:f.enumTypeGetter,getKeyForReferenceType:f.getKeyForReferenceType,info:{Attributes:o,FieldId:n,IsCollection:f.info.IsCollection,IsLeaf:f.info.IsLeaf,Name:i,Path:u||i},parentMasterClass:t,parentSchema:t.__nerve__.schema,shadowParent:c,shadowRoot:c,subMasterClassGetter:function(){return r},withDataSource:f.withDataSource}),a={};return a[on(r.__nerve__.schema)]=h,h.__nerve__.generateProperty=function(n){return function(t,r){return new L(t,n,r)}}(h),(0,s.z2)(h.__nerve__,"generateProperty"),h.__nerve__.shadowMapper=function(n,t){return function r(i){var u=on(i),o=t[u];if(!o){var c=i.__nerve__.parentSchema;o=(rn(c)?r(c):n)[cn(i)],(0,e.hu)(o===t[u],"the new shadow should be added into the shadow map.")}return o}}(h,a),(0,s.z2)(h.__nerve__,"shadowMapper"),J(h,r.Schema,a),h}function J(n,t,r){Object.keys(t).forEach((function(i){(0,s.EA)(n,i,function(n,t,r,i){return function(){var e=t[r],u=e.__nerve__,o=dn({enumTypeGetter:u.enumTypeGetter,getKeyForReferenceType:u.getKeyForReferenceType,info:{Attributes:u.info.Attributes,FieldId:mn(),IsCollection:u.info.IsCollection,IsLeaf:u.info.IsLeaf,Name:r,Path:bn(n.__nerve__.info.Path,r)},parentSchema:n,parentMasterClass:n.__nerve__.parentMasterClass,shadowParent:e,shadowRoot:u.shadowRoot,subMasterClassGetter:u.subMasterClassGetter,withDataSource:u.withDataSource});return i[on(e)]=o,J(o,e,i),o}}(n,t,i,r))}))}var V={ObjectSynchronizer:void 0},_=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),t.prototype.getSnapshot=function(t){var r=n.prototype.getSnapshot.call(this,t);if(!t)return r;var i={};return this.Master.Schema.__nerve__.subFields.intersection(t).toArray().map(cn).forEach((function(n){return i[n]=r[n]})),i},t.prototype.initializeSnapshot=function(){var n=this;this.dn={};var t=this.Master,r=t.Schema.__nerve__.subFields.toArray();if(q(t)){var i=t;r=r.filter((function(n){return i.isFieldReady(n)}))}r.forEach((function(t){return n.Mn(t)}))},t.prototype.refreshSubSnapshot=function(n){this.Mn(n.FieldSchema)},t.prototype.createSnapshotCache=function(){return Object.freeze((0,s.kI)(this.dn))},t.prototype.createChange=function(t){var r=n.prototype.createChange.call(this,t);return r.UpdateNeeded||(r.UpdateNeeded=t.toArray().some((function(n){return n.__nerve__.info.IsLeaf&&!n.__nerve__.info.Attributes.IsLocalField}))),r.UpdateNeeded||(r.UpdateNeeded=r.SubChanges.filter((function(n){return n.UpdateNeeded})).some((function(n){var r=n.Master.Membership.FieldSchema;return t.has(r)&&!r.__nerve__.info.Attributes.IsLocalField}))),r},t.prototype.removeUnchangedFields=function(n,t){var r=this,i=this.Master.Schema,e=n.toArray().filter((function(n){if(n.__nerve__.parentSchema===i&&S(n)){var e=cn(n);return r.Master.Model[e]===t[e]}return!1}));n.removeFieldSchemas(e)},t.prototype.Mn=function(n){var t=cn(n),r=this.Master.Model[t];if(S(n))this.dn[t]=r;else{var i=f(r);this.dn[t]=i.getSnapshot()}},t}(v),B=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),t.prototype.initializeSourceData=function(n){n=this.Nn(n);var t=this.Master.Schema,r=this.Master.Model.__nerve__.properties;for(var i in r){var e=t[i].__nerve__.sourceName;r[i].getDirtyChecker().initializeSourceData(n[e])}},t.prototype.getDelta=function(){var n=this;if(this.isDirty()){var t=this.Master.Schema,r={};return this.getDirtyKeys().sort().forEach((function(i){var e=t[i].__nerve__.sourceName;r[e]=n.Dn(i).getSnapshotToUpdate()})),r}},t.prototype.getSnapshotToUpdate=function(){var n={},t=this.Master.Schema,r=this.Tn();for(var i in r){n[t[i].__nerve__.sourceName]=r[i].getSnapshotToUpdate()}return n},t.prototype.getSourceData=function(){var n={},t=this.Master.Schema,r=this.Tn();for(var i in r){n[t[i].__nerve__.sourceName]=r[i].getSourceData()}return n},t.prototype.setSourceData=function(n){var t=this;n=this.Nn(n),Object.keys(n).forEach((function(r){t.En(r).setSourceData(n[r])}))},t.prototype.onSourceDataReceived=function(n){var t,r=this;n=this.Nn(n);var i=this.Master;if(q(i)){t=new s.wU;var e=this.Master.Schema.__nerve__.sourceNameToClientName,u=Object.keys(n).map((function(n){return e[n]})).filter((function(n){return n}));i.Synchronizer.markFieldsAsReady(u,t.promise())}i.bulkEdit((function(){Object.keys(n).forEach((function(t){r.En(t).onSourceDataReceived(n[t])}))})),t&&t.resolve()},t.prototype.Nn=function(n){var t=this.Master.Schema.__nerve__.sourceNameToClientName,r={};return n?Object.keys(n).filter((function(n){return n in t})).forEach((function(t){return r[t]=n[t]})):Object.keys(t).forEach((function(n){return r[n]=null})),r},t.prototype.Tn=function(){var n=this.Master.Model.__nerve__.properties,t={};return this.Master.Schema.__nerve__.subFields.toArray().filter((function(n){return!n.__nerve__.info.Attributes.IsLocalField})).map(cn).forEach((function(r){return t[r]=n[r].getDirtyChecker()})),t},t.prototype.Dn=function(n){return this.Master.Model.__nerve__.properties[n].getDirtyChecker()},t.prototype.En=function(n){var t=this.Master.Schema.__nerve__.sourceNameToClientName[n];return this.Dn(t)},t}(I),W=function(n){function t(t,r,i,u,o,c){var f,h={};f=n.call(this,{master:t,properties:h})||this;var a=function(n){return q(n)?function(t,r){var i=function(){if(!n.isFieldReady(r)){var t=sn(r);(0,e._y)("The field (".concat(t,") not ready yet."))}};return{getter:function(){return i(),t.getter()},setter:function(n){i(),t.setter(n)}}}:function(n,t){return{getter:function(){return n.getter()},setter:function(t){return n.setter(t)}}}}(t);return Object.keys(t.Schema).forEach((function(n){var e=t.Schema[n],l=e.__nerve__.generateProperty(n,{InitialData:r[n],ExistingInDataSource:i,MasterTreeReady:o,Reserved:{Membership:{FieldSchema:e,Parent:t},ParentExistingInDataSource:c,Mounted:u}});h[n]=l;var v=a(l,e);(0,s._x)(f,n,v.getter,v.setter)})),f}return(0,i.ZT)(t,n),t}(c);var Z="object master";function q(n){return n instanceof Y}function H(n,t,r){(0,p.bn)(n,t);var e=function(n){function t(t,i){return n.call(this,t,i,r)||this}return(0,i.ZT)(t,n),Object.defineProperty(t,"Schema",{get:function(){return t.__nerve__.schema},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Schema",{get:function(){return t.__nerve__.schema},enumerable:!1,configurable:!0}),t}(r?Y:X);return(0,o.s)(e,(0,s.fm)({nerveObjectType:Z,masterName:n,dataSourceFactory:r}),!0),e.__nerve__.schema=vn(e,t),(0,s.z2)(e.__nerve__,"schema"),e}var X=function(n){function t(t,r,i){var e;t=t||{},r=r||{};var u=(e=n.call(this,t)||this).__nerve__;u.markChildrenAsDeleted=function(){var n;(n=e).Schema.__nerve__.subFields.toArray().filter((function(n){return!S(n)})).map(cn).map((function(t){return n.Model.__nerve__.properties[t]})).map((function(n){return n.Master})).forEach((function(n){return n.Deleted=!0}))},(0,s.z2)(u,"markChildrenAsDeleted");var o,c=new s.wU,f=(0,s.GP)(r.MasterReady,c.promise()),h=!i&&u.membership&&!u.membership.FieldSchema.__nerve__.info.Attributes.IsLocalField;if(u.dirtyChecker=new B(e,t.ExistingInDataSource,h),(0,s.z2)(u,"dirtyChecker"),i?(u.synchronizer=new V.ObjectSynchronizer(e,t,r,f,i),o=u.synchronizer.existingInDataSource()):(u.synchronizer=null,o=t.Reserved&&t.Reserved.ParentExistingInDataSource),(0,s.z2)(u,"synchronizer"),u.model=new W(e,t.InitialData||{},t.ExistingInDataSource,f,(0,s.GP)(t.MasterTreeReady,f).then((function(){})),o),(0,s.z2)(u,"model"),u.changeManager=new _(e),(0,s.z2)(u,"changeManager"),i){var a=an(t.ExistingInDataSource?t.InitialData:null,e.Schema);u.dirtyChecker.initializeSourceData(a)}return c.resolve(),e}return(0,i.ZT)(t,n),t.prototype.setData=function(n,t){var r=this.Model;if(n!==r){var i;if(n=n||{},t)i=$(this,t);else{var u=this.Schema;i=Object.keys(n).map((function(n){return u[n]})).filter((function(n){return n}))}var o=[];this.bulkEdit((function(){i.map(cn).forEach((function(t){t in r?r[t]=n[t]:o.push(t)}))})),o.length&&(0,e.ZK)("following field(s) not found in ".concat(h(this),": ").concat(o))}},t.prototype.getModelByFieldSchema=function(n){var t=n;en(t),t=nn(this,t);for(var r=this.Schema,i=[];t!==r;){if(i.push(t),t.__nerve__.info.IsCollection)throw Error("unable to get model/value from collection ".concat(sn(t),"."));t=t.__nerve__.parentSchema}var e=this.Model;do{e=e[cn(t=i.pop())]}while(i.length);return e},t}(a),Y=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),Object.defineProperty(t.prototype,"Synchronizer",{get:function(){return this.__nerve__.synchronizer},enumerable:!1,configurable:!0}),t.prototype.isFieldReady=function(n){return this.Synchronizer.isFieldReady(n)},t.prototype.ensureFieldsReady=function(n){return this.Synchronizer.ensureFieldsReady(n)},t.prototype.fieldsReady=function(n){return this.Synchronizer.fieldsReady(n)},t.prototype.getRelatedSourceFields=function(n){return n},t.prototype.forceFieldsReady=function(n){return this.Synchronizer.forceFieldsReady(n)},t}(X);function $(n,t){return t.map((function(t){var r=n.Schema;if("string"==typeof t){var i=r[t];if(rn(i))return i}else if(rn(t))return nn(n,t);(0,e._y)("field ".concat(t," doesn't exist in master ").concat(h(n)))}))}function nn(n,t){for(var r=n.Schema,i=[];t.__nerve__.shadowRoot!==r;){var u=cn(t);i.push(u),(t=t.__nerve__.parentSchema)||(0,e._y)("field schema (".concat(sn(t),") is not a member schema of master (").concat(h(n),")"))}for(var o=r;i.length;){o=o[u=i.pop()]}return o}var tn="FieldSchema";function rn(n){var t=n&&n.__nerve__;return t&&t.nerveObjectType===tn}function en(n){if(!rn(n))throw Error("Invalid parameter: please use '<your master [class]>.Schema.*' for the parameter.");return!0}function un(n){return en(n),n.__nerve__.info}function on(n){return un(n).FieldId}function cn(n){return un(n).Name}function sn(n){return un(n).Path}function fn(n){return yn[n]}function hn(n,t){if(S(t)){if(t.__nerve__.asEnum){var r=t.__nerve__.enumType;if(r&&"string"==typeof n&&n in r)return r[n]}return n}if(z(t))return(0,s.L)(n).map((function(n){return hn(n,t[0])}));if(n){var i={},e=t.__nerve__.sourceNameToClientName;return Object.keys(n).forEach((function(r){if(r in e){var u=e[r],o=t[u];i[u]=hn(n[r],o)}})),i}return null}function an(n,t){if(S(t)){if(t.__nerve__.asEnum){var r=t.__nerve__.enumType;if(r&&"number"==typeof n&&n in r)return r[n]}return n}if(z(t))return(0,s.L)(n).map((function(n){return an(n,t[0])}));if(n){var i={};return Object.keys(t).forEach((function(r){if(r in n){var e=t[r];if(!e.__nerve__.info.Attributes.IsLocalField){var u=e.__nerve__.sourceName;i[u]=an(n[r],e)}}})),i}return null}function ln(n,t){if(S(t))return n;if(z(t))return(0,s.L)(n).map((function(n){return ln(n,t[0])}));if(n){var r={},i=t.__nerve__.sourceNameToClientName;return Object.keys(n).forEach((function(e){if(e in i){var u=t[i[e]];r[e]=ln(n[e],u)}})),r}return null}function vn(n,t){var r=n.__nerve__.masterName,e={enumTypeGetter:null,getKeyForReferenceType:null,info:{Attributes:(0,p.u9)(t),FieldId:mn(),IsCollection:!(!(0,p.f4)(t)||!t.__nerve__.isCollection),IsLeaf:!1,Name:r,Path:r},parentMasterClass:n,shadowParent:null,withDataSource:!!n.__nerve__.dataSourceFactory};e.info.IsCollection&&(0,s.EA)(e,"withDataSource",(function(){return u[0].__nerve__.withDataSource}));var u=dn(e);return Object.keys(t).forEach((function(r){(0,s.EA)(u,r,function(n,t,r){var e=mn();return function(){var u,c=bn(n.__nerve__.masterName,t);if((0,p.f4)(r)){if(r.__nerve__.isLeaf)return O(e,n,r,t,c);r.__nerve__.isCollection?u=function(n,t){var r=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return(0,i.ZT)(t,n),Object.defineProperty(t,"Schema",{get:function(){return t.__nerve__.schema},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"Schema",{get:function(){return t.__nerve__.schema},enumerable:!1,configurable:!0}),t}(U);return(0,o.s)(r,(0,s.fm)({nerveObjectType:G,masterName:n}),!0),r.__nerve__.schema=vn(r,t),(0,s.z2)(r.__nerve__,"schema"),r}(c,r):r.__nerve__.masterClassGetter&&(u=r.__nerve__.masterClassGetter())}u||(u=H(c,r));var f=(0,p.u9)(r);return Q(e,n,u,t,c,f)}}(n,r,t[r]))})),u}function dn(n){var t={};return n.info=(0,s.fm)(n.info),n.nerveObjectType=tn,n.shadowParent=n.shadowParent||null,n.shadowRoot=n.shadowRoot||t,(0,s.EA)(n,"sourceFieldSet",(function(){var t=n.subFields.toArray().filter((function(n){return!n.__nerve__.info.Attributes.IsLocalField}));return new u(t)})),(0,s.EA)(n,"sourceName",(function(){return n.info.Attributes.SourceFieldName||n.info.Name})),(0,s.EA)(n,"sourceNameToClientName",(function(){var t={};return n.sourceFieldSet.toArray().forEach((function(n){t[n.__nerve__.sourceName]=n.__nerve__.info.Name})),Object.freeze(t)})),(0,s.EA)(n,"subFields",(function(){var n=new u;return Object.keys(t).forEach((function(r){n.addFieldSchema(t[r])})),n})),(0,s.EA)(n,"allContainedFields",(function(){var n=new u([t]);return Object.keys(t).forEach((function(r){var i=t[r];n.addFieldSchemas(i.__nerve__.allContainedFields)})),n})),(0,s.EA)(n,"asEnum",(function(){return!!n.enumType&&!n.info.Attributes.IsNumberTypeInDataSource})),(0,s.EA)(n,"enumType",(function(){return n.enumTypeGetter&&n.enumTypeGetter()})),n.info.IsLeaf?(0,s.EA)(n,"getKey",(function(){return(0,e.hu)(n.getKeyForReferenceType,"getKey has been called but no keyGetter specified for ".concat(n.info.Path)),n.getKeyForReferenceType})):(0,s.EA)(n,"getKey",(function(){var t=n.keyFields.toArray().map(cn).sort();return(0,e.hu)(t.length>0,"getKey has been called but there's no key fields of ".concat(n.info.Path)),function(n){var r=t;if(n instanceof W){var i=n.__nerve__.master;if(q(i)){var e=i;if(!(r=t.filter((function(n){return e.isFieldReady(n)}))).length)return}}var u={};return r.forEach((function(t){return u[t]=n[t]})),JSON.stringify(u)}})),(0,s.EA)(n,"getKeyFromSourceData",(function(){var t=n.keyFields.toArray(),r=n.sourceNameToClientName,i=t.map((function(n){return n.__nerve__.sourceName}));return function(t){var e={};return i.forEach((function(n){var i=r[n];e[i]=t[n]})),n.getKey(e)}})),(0,s.EA)(n,"keyFields",(function(){return new u(n.subFields.toArray().filter((function(n){return n.__nerve__.info.Attributes.IsKeyField})))})),(0,s.EA)(n,"ignoreKeyWithEmptyValueFields",(function(){return new u(n.subFields.toArray().filter((function(n){return n.__nerve__.info.Attributes.IgnoreKeyWithEmptyValue}))).toArray().reduce((function(n,t){var r={};return r[t.__nerve__.sourceName]=null,n[JSON.stringify(r)]=!0,n}),{})})),n.info.IsLeaf?(0,s.EA)(n,"withKey",(function(){return!!n.getKeyForReferenceType})):(0,s.EA)(n,"withKey",(function(){return n.keyFields.Count>0})),(0,o.s)(t,n),(0,s.zO)(t,"toJSON",(function(){return"[Nerve] FieldSchema: (".concat(n.info.Path,")>")}),!1),n.info.IsCollection&&(0,s.zO)(t,"length",1,!1),yn[n.info.FieldId]=t,t}function bn(n,t){return"".concat(n,"/").concat(t)}function mn(){return(gn++).toString()}var gn=1,yn={},wn=function(n){function t(){var t=n.call(this,{InitialData:{InProcess:!1,AllSucceeded:!0,Scheduled:!1,CreationError:null,CreationFailed:!1,CreationInProcess:!1,CreationRetryScheduled:!1,CreationScheduled:!1,QueryError:null,QueryFailed:!1,QueryInProcess:!1,UpdateError:null,UpdateFailed:!1,UpdateInProcess:!1,UpdateRetryScheduled:!1,UpdateScheduled:!1}})||this;return t.addRule(pn),t.addRule(Sn),t.addRule(On),t}return(0,i.ZT)(t,n),t}(H("Nerve.ObjectSynchronizerMaster",{InProcess:p.J4.boolean(),AllSucceeded:p.J4.boolean(),Scheduled:p.J4.boolean(),CreationError:p.J4.reference(),CreationFailed:p.J4.boolean(),CreationInProcess:p.J4.boolean(),CreationScheduled:p.J4.boolean(),CreationRetryScheduled:p.J4.boolean(),QueryError:p.J4.reference(),QueryFailed:p.J4.boolean(),QueryInProcess:p.J4.boolean(),UpdateError:p.J4.reference(),UpdateFailed:p.J4.boolean(),UpdateInProcess:p.J4.boolean(),UpdateRetryScheduled:p.J4.boolean(),UpdateScheduled:p.J4.boolean()})),pn={Name:"InProcess",InterestedFields:[wn.Schema.CreationInProcess,wn.Schema.QueryInProcess,wn.Schema.UpdateInProcess],onChange:function(n){var t=n.Master.Model;t.InProcess=t.CreationInProcess||t.QueryInProcess||t.UpdateInProcess}},Sn={Name:"AllSucceeded",InterestedFields:[wn.Schema.CreationFailed,wn.Schema.QueryFailed,wn.Schema.UpdateFailed],onChange:function(n){var t=n.Master.Model;t.AllSucceeded=!(t.CreationFailed||t.QueryFailed||t.UpdateFailed)}},On={Name:"Scheduled",InterestedFields:[wn.Schema.CreationScheduled,wn.Schema.CreationRetryScheduled,wn.Schema.UpdateScheduled,wn.Schema.UpdateRetryScheduled],onChange:function(n){var t=n.Master.Model;t.Scheduled=t.CreationScheduled||t.CreationRetryScheduled||t.UpdateScheduled||t.UpdateRetryScheduled}},jn=function(){function n(n){n?(this.kn=new In({retry:n.retryForCreation&&n.retryForCreation.bind(n),cancel:n.cancelRetryForCreation&&n.cancelRetryForCreation.bind(n)}),this.Kn=new In({retry:n.retryForUpdate&&n.retryForUpdate.bind(n),cancel:n.cancelRetryForUpdate&&n.cancelRetryForUpdate.bind(n)})):(this.kn=new In,this.Kn=new In),this.An=n||{}}return n.prototype.scheduleUpdate=function(){return this.Rn?(this.An.postponeUpdate&&this.An.postponeUpdate(),this.Rn.promise()):this.xn()},n.prototype.postponeUpdate=function(){this.An.postponeUpdate&&this.An.postponeUpdate()},n.prototype.flush=function(){this.kn.flush(),this.Kn.flush(),this.Gn&&(this.Gn.cancel(),this.Gn=void 0,this.An.cancelUpdate&&this.An.cancelUpdate()),this.Rn&&(this.Rn.resolve(),this.Rn=void 0)},n.prototype.cancelUpdate=function(){this.Rn&&(this.Rn.reject(),this.Rn=void 0,this.An.cancelUpdate&&this.An.cancelUpdate())},n.prototype.retryForCreation=function(n){return this.kn.retry(n)},n.prototype.cancelRetryForCreation=function(){return this.kn.cancel()},n.prototype.retryForUpdate=function(n){return this.Kn.retry(n)},n.prototype.cancelRetryForUpdate=function(){return this.Kn.cancel()},n.prototype.xn=function(){var n=this;this.Rn||(this.Rn=new s.wU);var t,r=this.Rn;return t=this.An.scheduleUpdate?this.An.scheduleUpdate():Promise.resolve(),this.Gn=new s.uG(t),this.Gn.promise().finally((function(){n.Rn=void 0,n.Gn=void 0})).then((function(){r.resolve()}),(function(){r.reject(new Error("this.cancelableUpdateSchedule rejected."))})),r.promise()},n}(),In=function(){function n(n){this.An=n||{}}return n.prototype.retry=function(n){var t=this;return this.An.retry?(this.cancel(),this.Un=new s.uG(this.An.retry(n)),this.Ln=new Promise((function(n,r){t.zn=n,t.Qn=r})),this.Un.promise().finally((function(){t.Ln=void 0,t.Un=void 0})).then(this.zn,this.Qn),this.Ln):Promise.reject("Scheduler has no retry.")},n.prototype.flush=function(){this.Un&&(this.Un.cancel(),this.Un=void 0,this.An.cancel&&this.An.cancel()),this.Ln&&(this.Ln=void 0,this.zn())},n.prototype.cancel=function(){this.Un&&(this.Un.cancel(),this.Ln=void 0,this.Un=void 0,this.An.cancel&&this.An.cancel())},n}(),Fn=function(n){function t(t,r,i,e,u){var o=n.call(this)||this;o.Jn=new s.wU,o.Vn=new s.wU,o._n={},o.Bn={},o.Wn={},o.Zn=Promise.resolve(),o.qn=0,o.Hn=[],o.C=t,o.An=new jn(i.Scheduler),o.Xn();var c=r.Reserved&&r.Reserved.ParentExistingInDataSource;o.Yn=(0,s.GP)(r.MasterTreeReady,e,c).then((function(){return u(t,(function(n){return o.onSourceDataReceived(n)}),i.DataSourceContext)}));var f=o.$n(r);if(f.length){var h=(0,s.Je)();f.forEach((function(n){o._n[n]=!0,o.Bn[n]=h}))}return e.then((function(){t.observe((function(n){n.UpdateNeeded&&o.nt()}))})),!r.ExistingInDataSource?o.tt():(o.rt=new s.bC(e),e.then((function(){return o.nt()}))),o}return(0,i.ZT)(t,n),t.prototype.flush=function(){var n=this;return this.An.flush(),this.rt.promise().then((function(){return n.Vn.promise()}))},t.prototype.existingInDataSource=function(){return this.rt.promise()},t.prototype.existingInDataSourcePromiseState=function(){return this.rt.states()},t.prototype.deletedFromDataSource=function(){var n=this;return this.rt.promise().then((function(){return n.Jn.promise()}),(function(){return Promise.resolve()}))},t.prototype.isFieldReady=function(n){n=this.C.getRelatedSourceFields([n])[0];var t=cn($(this.C,[n])[0]);return!!this._n[t]},t.prototype.ensureFieldsReady=function(n){var t=this;n=this.C.getRelatedSourceFields(n);var r=$(this.C,n);return r.filter((function(n){return!t.isFieldReady(n)})).length?this.rt.promise().then((function(){var n=r.filter((function(n){return!t.isFieldReady(n)}));if(n.length)return t.query(n)})).then((function(){return t.it()})):Promise.resolve()},t.prototype.forceFieldsReady=function(n){var t=this;n=this.C.getRelatedSourceFields(n),$(this.C,n).filter((function(n){return!t.isFieldReady(n)})).forEach((function(n){t._n[cn(n)]=!0}))},t.prototype.fieldsReady=function(n){var t=this;n=this.C.getRelatedSourceFields(n);var r=$(this.C,n).map(cn).map((function(n){return t.Bn[n]||(t.Bn[n]=new s.wU),t.Bn[n].promise()}));return Promise.all(r).then((function(){return t.it()}))},t.prototype.query=function(n){var t=this;n=this.C.getRelatedSourceFields(n);var r=$(this.C,n);return this.rt.promise().then((function(){var n=[],i=new s.wU,e=new s.bC(i.promise().then((function(){return t.et(n)}))),u=[];return r.filter((function(n){return!n.__nerve__.info.Attributes.IsLocalField})).forEach((function(r){var i=cn(r),o=t.Wn[i];o&&o.states()===s.Cb.Pending||(t.Wn[i]=e,n.push(r.__nerve__.sourceName)),u.push(t.Wn[i].promise())})),n.length?i.resolve():i.reject(new Error("FieldNamesToQuery is empty.")),Promise.all(u)})).then((function(){return t.it()}))},t.prototype.onSourceDataReceived=function(n){var t=this,r=ln(n,this.C.Schema);return this.Hn.push(r),this.Zn.then((function(){return t.ut()}))},t.prototype.onDeletedInDataSource=function(){this.ot().ExistingInSource=!1,this.C.Deleted=!0},t.prototype.setFieldsQueryJob=function(n,t){var r=this,i=$(this.C,this.C.getRelatedSourceFields(n)).filter((function(n){return!n.__nerve__.info.Attributes.IsLocalField})),e=new s.wU,u=e.promise().then((function(){return t})).then((function(n){var t={};return i.map((function(n){return n.__nerve__.sourceName})).forEach((function(r){return t[r]=n[r]})),r.onSourceDataReceived(t)}));i.map(cn).forEach((function(n){var t=r.Wn[n];t&&t.states()===s.Cb.Pending?r.Wn[n]=new s.bC((0,s.Ko)(t.promise(),u)):r.Wn[n]=new s.bC(u)})),e.resolve()},t.prototype.markFieldsAsReady=function(n,t){var r=this;n.forEach((function(n){return r._n[n]=!0})),t.then((function(){var t=(0,s.Je)();n.forEach((function(n){r.Bn[n]?r.Bn[n].resolve():r.Bn[n]=t}))}))},t.prototype.Xn=function(){var n=this;this.Vn=(0,s.Je)(),this.observe((function(){return n.st()}),[this.Schema.UpdateError,this.Schema.UpdateFailed,this.Schema.UpdateInProcess,this.Schema.UpdateScheduled])},t.prototype.st=function(){var n=this.Model;n.UpdateScheduled||n.UpdateInProcess?this.Vn.states()!==s.Cb.Pending&&(this.Vn=new s.wU):n.UpdateFailed?n.UpdateRetryScheduled||this.Vn.reject(n.UpdateError):this.Vn.resolve()},t.prototype.$n=function(n){var t=this.C.Schema.__nerve__.subFields;if(n.ExistingInDataSource){var r=n.InitialData||{},i=[];return t.toArray().forEach((function(n){var t=cn(n);(n.__nerve__.info.Attributes.IsLocalField||t in r)&&i.push(t)})),i}return t.toArray().filter((function(n){return!n.__nerve__.info.Attributes.IsSourceGenerated})).map(cn)},t.prototype.nt=function(){var n=this;this.ot().isDirty()?(this.bulkEdit((function(){n.Model.UpdateScheduled=!0})),(0,s.GP)(this.rt.promise(),this.An.scheduleUpdate()).then((function(){n.qn=0,n.ft()}),(function(){}))):(this.An.cancelUpdate(),this.Model.UpdateScheduled=!1)},t.prototype.ft=function(){if(this.ht)this.lt=!0;else if(this.ot().isDirty()){if(this.vt(),this.ot().isDirty())return this.C.__nerve__.deleted?this.dt():this.bt();(0,e.ZK)("onUpdateStart changes dirtiness."),this.gt()}else this.gt()},t.prototype.ot=function(){return this.C.__nerve__.dirtyChecker},t.prototype.tt=function(){var n=this,t=this.C,r=new Promise((function(r,i){n.bulkEdit((function(){n.Model.CreationScheduled=!0,n.Yn.then((function(e){var u=function(){if(n.An.cancelRetryForCreation(),t.__nerve__.deleted)return n.bulkEdit((function(){n.Model.CreationFailed=!1,n.Model.CreationInProcess=!1,n.Model.CreationRetryScheduled=!1,n.Model.CreationScheduled=!1}));n.bulkEdit((function(){n.Model.CreationError=null,n.Model.CreationFailed=!1,n.Model.CreationInProcess=!0,n.Model.CreationRetryScheduled=!1,n.Model.CreationScheduled=!1}));var c=n.ot(),s=c.getDelta()||{},f=c.getSnapshotToUpdate(),h=n.Zn.then((function(){return e.add(s,{Master:t,Snapshot:f})})).then((function(i){t.bulkEdit((function(){c.ExistingInSource=!0,c.setSourceData(s),i&&n.yt(i)})),n.bulkEdit((function(){n.Model.CreationInProcess=!1,n.nt()})),r()})).catch((function(t){n.bulkEdit((function(){n.Model.CreationFailed=!0,n.Model.CreationError=t,n.Model.CreationInProcess=!1,n.Model.CreationRetryScheduled=!0,n.An.retryForCreation(++o).then(u).catch((function(){n.Model.CreationRetryScheduled=!1,i(t)}))}))}));n.wt(h)},o=0;u()}))}))}));this.rt=new s.bC(r)},t.prototype.dt=function(){var n=this,t=this.ot(),r=this.Zn.then((function(){return n.Yn})).then((function(r){var i=t.getSnapshotToUpdate();return r.delete(i,{Master:n.C,Snapshot:i})})).then((function(){return t.ExistingInSource=!1}));return this.wt(r),r.then((function(t){return n.gt(!1),n.Jn.resolve(),t})).catch((function(t){throw n.St(t,!1,(function(){n.Jn.reject(t)})),t}))},t.prototype.et=function(n){var t=this,r=this.Zn.then((function(){return t.Yn})).then((function(r){return t.bulkEdit((function(){t.Model.QueryError=null,t.Model.QueryInProcess=!0})),r.query(n,{Master:t.C,Snapshot:null})})).then((function(r){if(r){var i={};Object.keys(r).concat(n).forEach((function(n){return i[n]=r[n]})),t.yt(i)}}));return this.wt(r),r.then((function(){t.Model.QueryInProcess=!1})).catch((function(n){throw t.bulkEdit((function(){t.Model.QueryError=n,t.Model.QueryInProcess=!1})),n}))},t.prototype.bt=function(){var n=this,t=this.ot(),r=t.getDelta(),i=t.getSnapshotToUpdate(),u=t.getSourceData();null==r&&(0,e.ZK)("data is null when it's dirty.");var o=this.Zn.then((function(){return n.Yn})).then((function(t){return t.update(r,{Master:n.C,Snapshot:i,ValuesBefore:u})})).then((function(i){n.C.bulkEdit((function(){t.setSourceData(r),i&&n.yt(i)}))}));return this.wt(o),o.then((function(){return n.gt(!0)})).catch((function(t){throw n.St(t,!0),t}))},t.prototype.vt=function(){var n=this;this.ht=!0,this.lt=!1,this.An.cancelRetryForUpdate(),this.bulkEdit((function(){n.Model.UpdateError=null,n.Model.UpdateFailed=!1,n.Model.UpdateInProcess=!0,n.Model.UpdateRetryScheduled=!1,n.Model.UpdateScheduled=!1}))},t.prototype.gt=function(n){var t=this;this.ht=!1,this.qn=0,this.An.cancelRetryForUpdate(),this.bulkEdit((function(){t.Model.UpdateError=null,t.Model.UpdateFailed=!1,t.Model.UpdateInProcess=!1,t.Model.UpdateRetryScheduled=!1,t.Model.UpdateScheduled=!1,n&&(t.lt?t.ft():t.nt())}))},t.prototype.St=function(n,t,r){var i=this;this.ot().isDirty()?(this.ht=!1,this.bulkEdit((function(){i.Model.UpdateError=n,i.Model.UpdateFailed=!0,i.Model.UpdateInProcess=!1,i.Model.UpdateRetryScheduled=!0,i.Model.UpdateScheduled=!0,t&&i.lt?i.ft():i.An.retryForUpdate(++i.qn).then((function(){return i.ft()})).catch((function(){i.bulkEdit((function(){i.Model.UpdateRetryScheduled=!1,i.Model.UpdateScheduled=!1})),r&&r()}))}))):this.gt()},t.prototype.yt=function(n){var t=ln(n,this.C.Schema);this.ot().onSourceDataReceived(t)},t.prototype.wt=function(n){var t=this;this.Zn=(0,s.Bx)(n).then((function(){return t.ut()}))},t.prototype.ut=function(){var n=this.ot(),t=this.Hn;this.Hn=[],this.C.bulkEdit((function(){t.forEach((function(t){return n.onSourceDataReceived(t)}))}))},t.prototype.it=function(){return this.C.__nerve__.changeManager.getChangingPeriod()},t}(wn);V.ObjectSynchronizer=Fn;var Cn=function(){function n(){}return n.getSubFieldSchemas=function(n){return function(n){return en(n),n.__nerve__.subFields.toArray()}(n)},n.convertFromSourceData=function(n,t){return hn(n,t)},n.convertToSourceData=function(n,t){return an(n,t)},n.convertToArray=function(n){return(0,s.L)(n)},n.getFieldSchemaInfo=function(n){return un(n)},n.getObjectMasterFromModel=function(n){return f(n)},n.getCollectionMasterFromModel=function(n){return f(n)},n.createObjectMasterClass=function(n,t,r){return H(n,t,r)},n.isObjectMasterClass=function(n){return function(n){var t=n;return!!t.__nerve__&&t.__nerve__.nerveObjectType===Z}(n)},n}();(0,s.z2)(Cn,"convertToArray"),(0,s.z2)(Cn,"getFieldSchemaInfo"),(0,s.z2)(Cn,"getSubFieldSchemas"),(0,s.z2)(Cn,"convertFromSourceData"),(0,s.z2)(Cn,"convertToSourceData"),(0,s.z2)(Cn,"createObjectMasterClass"),(0,s.z2)(Cn,"getObjectMasterFromModel"),(0,s.z2)(Cn,"getCollectionMasterFromModel"),(0,s.z2)(Cn,"isObjectMasterClass");var Pn={addItems:null,deleteItems:null,getIndexWithKeyFields:null,getItemWithKeyFields:null,itemsAddedInSource:null,itemsDeletedInSource:null,markAsChanged:null,setComparer:null};for(var Mn in Pn)Pn[Mn]=Nn(Mn);function Nn(n){return function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var e=Cn.getCollectionMasterFromModel(t),u=e[n];return u.apply(e,r)}}Cn.Collection=Object.freeze(Pn),(0,s.z2)(Cn,"Collection")}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/design-page.cachegroup-nerve.min.c0239a3.js.map/6f28a8f2f9f57a29ff120176f608e109057e16f0046c564f773f8553c4e3f7c6/design-page.cachegroup-nerve.min.c0239a3.js.map